!function(){var R,D,I,E,O,t=!1;function L(t,e){return t.right=e.right,t.width=t.right-t.left,e.y&&(t.y=e.y),t}function T(t,e){var i=e?t[0]:t[t.length-1],n=e?"top":"bottom";return CKEDITOR.tools.array.filter(t,function(t){if(t[n]===i[n])return t})}CKEDITOR.plugins.add("balloonpanel",{init:function(){t||(CKEDITOR.document.appendStyleSheet(this.path+"skins/"+CKEDITOR.skin.name+"/balloonpanel.css"),t=!0)}}),CKEDITOR.ui.balloonPanel=function(t,e){for(var i in this.editor=t,CKEDITOR.tools.extend(this,{width:360,height:"auto",triangleWidth:20,triangleHeight:20,triangleMinDistance:40},e,!0),this.templates={},this.templateDefinitions)this.templates[i]=new CKEDITOR.template(this.templateDefinitions[i]);this.parts={},this.focusables={},this.showListeners={},this.activeShowListeners={},this.rect={visible:!1},this.build(),t.on("destroy",function(){this.destroy()},this)},CKEDITOR.ui.balloonPanel.prototype={templateDefinitions:{panel:'<div class="cke {id} cke_reset_all cke_chrome cke_balloon cke_editor_{name} cke_{langDir} '+CKEDITOR.env.cssClass+'" dir="{langDir}" title="'+(CKEDITOR.env.gecko?" ":"")+'" lang="{langCode}" role="dialog" style="{style}" tabindex="-1" aria-labelledby="cke_{name}_arialbl"></div>',content:'<div class="cke_balloon_content">{content}</div>',title:'<div class="cke_balloon_title" role="presentation">{title}</div>',close:'<a class="cke_balloon_close_button" href="javascript:void(0)" title="Close" role="button" tabindex="-1"><span class="cke_label">X</span></a>',triangleOuter:'<span class="cke_balloon_triangle cke_balloon_triangle_outer"></span>',triangleInner:'<span class="cke_balloon_triangle cke_balloon_triangle_inner">&#8203;</span>'},build:function(){var t=this.editor;this.parts={title:CKEDITOR.dom.element.createFromHtml(this.templates.title.output({title:this.title})),close:CKEDITOR.dom.element.createFromHtml(this.templates.close.output()),panel:CKEDITOR.dom.element.createFromHtml(this.templates.panel.output({id:t.id,langDir:t.lang.dir,langCode:t.langCode,name:t.name,style:"display:none;",voiceLabel:t.lang.editorPanel+", "+t.name})),content:CKEDITOR.dom.element.createFromHtml(this.templates.content.output({content:this.content||""})),triangleOuter:CKEDITOR.dom.element.createFromHtml(this.templates.triangleOuter.output()),triangleInner:CKEDITOR.dom.element.createFromHtml(this.templates.triangleInner.output())},this.parts.panel.append(this.parts.title,1),this.parts.panel.append(this.parts.close,1),this.parts.panel.append(this.parts.triangleOuter),this.parts.panel.append(this.parts.content),this.parts.triangleOuter.append(this.parts.triangleInner),this.registerFocusable(this.parts.panel),this.registerFocusable(this.parts.close),this.parts.title.unselectable(),this.parts.close.unselectable(),CKEDITOR.document.getBody().append(this.parts.panel),this.resize(this.width,this.height),this.on("show",this.activateShowListeners,this),this.on("hide",this.deactivateShowListeners,this),this.parts.close.on("click",function(t){this.hide(),t.data.preventDefault()},this)},show:function(){this.rect.visible||(this.rect.visible=!0,this.parts.panel.show(),this.fire("show"))},hide:function(){this.rect.visible&&(this.rect.visible=!1,this.parts.panel.hide(),this.blur(),this.fire("hide"))},blur:function(){this.editor.focus()},move:function(t,e){this.rect.left=e,this.rect.top=t,this.parts.panel.setStyles({left:CKEDITOR.tools.cssLength(e),top:CKEDITOR.tools.cssLength(t)})},attach:(O={right:"left",top:"bottom",topLeft:"bottomLeft",topRight:"bottomRight",bottom:"top",bottomLeft:"topLeft",bottomRight:"topRight",left:"right"},function(t,e){var i,n,s;t instanceof CKEDITOR.dom.selection&&(o=t.getRanges(),i=(a=(o=t.isFake&&t.isInTable()?CKEDITOR.tools.array.map(o,function(t){return t.getClientRects(!0)[0]}):o[o.length-1].getClientRects(!0))[0])===(f=o[o.length-1])?[a]:a.top===f.top?[L(a,f)]:(s=T(n=o,!0),n=T(n),s=L(s[0],s.pop()),n=L(n[0],n.pop()),s.bottom=n.bottom,s.height=s.bottom-s.top,n.y&&(s.y=n.y),n.top=s.top,n.height=s.height,[s,n])),(e instanceof CKEDITOR.dom.element||!e)&&(e={focusElement:e}),!0===(e=CKEDITOR.tools.extend(e,{show:!0})).show&&this.show(),this.fire("attach"),R=CKEDITOR.document.getWindow(),D=this.editor.window.getFrame(),I=this.editor.editable(),!(E=I.isInline())&&CKEDITOR.env.safari&&(D=D.getParent());var o,a,l,h,r,c,g,p,m,d,f=(o=this.getWidth())*(a=this.getHeight()),u=t.getClientRect&&t.getClientRect(!0),b=E?I.getClientRect(!0):D.getClientRect(!0),v=R.getViewPaneSize(),_=R.getScrollPosition(),w={top:Math.max(b.top,_.y),left:Math.max(b.left,_.x),right:Math.min(b.right,v.width+_.x),bottom:Math.min(b.bottom,v.height+_.y)};for(var C in E&&this.editor.elementMode===CKEDITOR.ELEMENT_MODE_INLINE&&((w=this._getViewPaneRect(R)).right+=this.triangleWidth,w.bottom+=this.triangleHeight),i?(CKEDITOR.tools.array.forEach(i,function(t){this._adjustElementRect(t,E?w:b)},this),u=this._getAlignments(i[0],o,a),1<i.length&&(u["bottom hcenter"]=this._getAlignments(i[1],o,a)["bottom hcenter"]),h={"top hcenter":!0,"bottom hcenter":!0}):(this._adjustElementRect(u,E?w:b),u=this._getAlignments(u,o,a)),h||u){if(g=u[C].top,p=u[C].left,m=o,d=a,(g={top:g,left:p}).right=g.left+m,g.bottom=g.top+d,h=g,0==(h=u[C].areaDifference=f-(r=h,c=w,Math.max(0,Math.min(r.right,c.right)-Math.max(r.left,c.left))*Math.max(0,Math.min(r.bottom,c.bottom)-Math.max(r.top,c.top))))){l=C;break}h<u[l=l||C].areaDifference&&(l=C)}C=(h=this.parts.panel.getAscendant(function(t){return!(t instanceof CKEDITOR.dom.document)&&"static"!==t.getComputedStyle("position")}))?parseInt(h.getComputedStyle("margin-left"),10):0,h=h?parseInt(h.getComputedStyle("margin-top"),10):0,this.move(u[l].top-h,u[l].left-C),l=l.split(" "),this.setTriangle(O[l[0]],l[1]),!1!==e.focusElement&&(e.focusElement||this.parts.panel).focus()}),resize:function(t,e){this.rect.width=t,this.rect.height=e,this.parts.panel.setStyles({width:CKEDITOR.tools.cssLength(t),height:CKEDITOR.tools.cssLength(e)})},getWidth:function(){return"auto"===this.rect.width?this.parts.panel.getClientRect().width:this.rect.width},getHeight:function(){return"auto"===this.rect.height?this.parts.panel.getClientRect().height:this.rect.height},setTriangle:function(t,e){var i=this.parts.triangleOuter,n=this.parts.triangleInner;this.triangleSide&&(i.removeClass("cke_balloon_triangle_"+this.triangleSide),i.removeClass("cke_balloon_triangle_align_"+this.triangleAlign),n.removeClass("cke_balloon_triangle_"+this.triangleSide)),this.triangleSide=t,this.triangleAlign=e,i.addClass("cke_balloon_triangle_"+t),i.addClass("cke_balloon_triangle_align_"+e),n.addClass("cke_balloon_triangle_"+t)},registerFocusable:function(t){this.editor.focusManager.add(t),this.focusables[t.getUniqueId()]=t},deregisterFocusable:function(t){this.editor.focusManager.remove(t),delete this.focusables[t.getUniqueId()]},addShowListener:function(t){var e=CKEDITOR.tools.getNextNumber();this.showListeners[e]=t,this.rect.visible&&this.activateShowListener(e);var i=this;return{removeListener:function(){i.removeShowListener(e)}}},removeShowListener:function(t){this.deactivateShowListener(t),delete this.showListeners[t]},activateShowListener:function(t){this.activeShowListeners[t]=this.showListeners[t].call(this)},deactivateShowListener:function(t){this.activeShowListeners[t]&&this.activeShowListeners[t].removeListener(),delete this.activeShowListeners[t]},activateShowListeners:function(){for(var t in this.showListeners)this.activateShowListener(t)},deactivateShowListeners:function(){for(var t in this.activeShowListeners)this.deactivateShowListener(t)},destroy:function(){this.deactivateShowListeners(),this.parts.panel.remove()},setTitle:function(t){this.parts.title.setHtml(t)},_getAlignments:function(t,e,i){return{"right vcenter":{top:t.top+t.height/2-i/2,left:t.right+this.triangleWidth},"left vcenter":{top:t.top+t.height/2-i/2,left:t.left-e-this.triangleWidth},"top hcenter":{top:t.top-i-this.triangleHeight,left:t.left+t.width/2-e/2},"top left":{top:t.top-i-this.triangleHeight,left:t.left+t.width/2-this.triangleMinDistance},"top right":{top:t.top-i-this.triangleHeight,left:t.right-t.width/2-e+this.triangleMinDistance},"bottom hcenter":{top:t.bottom+this.triangleHeight,left:t.left+t.width/2-e/2},"bottom left":{top:t.bottom+this.triangleHeight,left:t.left+t.width/2-this.triangleMinDistance},"bottom right":{top:t.bottom+this.triangleHeight,left:t.right-t.width/2-e+this.triangleMinDistance}}},_adjustElementRect:function(t,e){t.left=Math.max(e.left,Math.min(e.right-1,t.left)),t.right=Math.max(e.left,Math.min(e.right,t.right)),t.top=Math.max(e.top,Math.min(e.bottom-1,t.top)),t.bottom=Math.max(e.top,Math.min(e.bottom,t.bottom))},_getViewPaneRect:function(t){var e=t.getScrollPosition();return t=t.getViewPaneSize(),{top:e.y,bottom:e.y+t.height,left:e.x,right:e.x+t.width}}},CKEDITOR.event.implementOn(CKEDITOR.ui.balloonPanel.prototype)}();